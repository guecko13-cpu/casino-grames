#!/bin/bash
set -eu

source /usr/share/yunohost/helpers

app=$YNH_APP_INSTANCE_NAME

install_dir=$(ynh_app_setting_get --app="$app" --key=install_dir)
port=$(ynh_app_setting_get --app="$app" --key=port)

ynh_script_progression --message="Installation des sources..." --weight=5
ynh_setup_source --dest_dir="$install_dir"

ynh_script_progression --message="Installation de MongoDB..." --weight=5
ynh_install_mongo

mongo_pwd=$(ynh_string_random --length=20)
ynh_app_setting_set --app="$app" --key=mongo_pwd --value="$mongo_pwd"

ynh_mongo_setup_db --db_user="$app" --db_name="$app" --db_pwd="$mongo_pwd"

mongo_uri="mongodb://$app:$mongo_pwd@127.0.0.1:27017/$app"
jwt_secret=$(ynh_string_random --length=32)
ynh_app_setting_set --app="$app" --key=jwt_secret --value="$jwt_secret"

yh_nlp=$(cat <<EOT
PORT=$port
MONGO_URI=$mongo_uri
JWT_SECRET=$jwt_secret
BCRYPT_ROUNDS=10
DEFAULT_BALANCE=1000
EOT
)

echo "$yh_nlp" > "$install_dir/.env"

ynh_script_progression --message="Installation des dépendances Node.js..." --weight=10
ynh_exec_as "$app" --env "PATH=$PATH_WITH_NODEJS:$PATH" --cwd "$install_dir" npm install --omit=dev

ynh_script_progression --message="Configuration de Nginx..." --weight=5
ynh_config_add_nginx

ynh_script_progression --message="Configuration du service systemd..." --weight=5
ynh_config_add_systemd

yunohost service start "$app"

ynh_script_progression --message="Installation terminée." --last
